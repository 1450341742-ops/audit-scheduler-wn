# 稽查员排班系统 V1.3 (V20.7修复启动500/距离重复)
在 V1.2 基础上新增：
1) 【城市距离表】可在页面维护（不改代码）
2) 【批量排班】按日期范围一键自动排（贪心+动态更新）

## 启动
Win10 双击 run.bat
打开 http://127.0.0.1:8000

## 新页面
- /distances 城市距离表维护
- /batch 批量排班（选择起止日期，一键为范围内未排任务自动生成团队并落库）

## 批量排班策略（MVP）
- 只处理“未排过”的任务（任务id在Schedule里不存在）
- 任务排序：need_expert优先 > 人数多优先 > 开始日期早优先
- 每排完一个任务，立即写入排班并更新人员 last_city/last_date/负荷，再排下一个（动态就近）
- 无可用方案会跳过并给出原因（简单提示）

## 配置
app/config.py 可调：缓冲日、链式阈值、专家组员是否也必须A等


## V2.0.3.2新增：批量排班“优化模式”
- /batch 页面新增模式选择：
  - 贪心（greedy）：沿用V1.3 (V20.7修复启动500/距离重复)
  - 优化（optimized）：在满足硬约束前提下，综合考虑“总差旅距离 + 负荷均衡”，选择全局更优的人员组合（启发式近似，不是黑盒）
- 参数可在 app/config.py 调整（权重系数）


## V2.0.3.2界面优化
- 所有表格支持横向滚动与不换行展示，避免字段被截断
- 稽查员/任务表单控件最小宽度提升，字段完整显示
- 批量排班：将“贪心”更名为“快速模式（优先效率）”


## V2.0.3.2字段解释
- 各页面表单字段下方增加简短说明（业务人员可直接理解怎么填）
- 各页面增加“注意排班”提示，强调硬约束/缓冲日/重排方式


## V2.0.3.2规则调整（万宁睿和版）
- A组与B组均可带队，带队能力同权（不单独加分）
- 新增任务字段：指定专家/老师（软指定：加分优先，不强制）
- 评分优先级调整：默认以节省差旅为第一优先（距离越近分越高），负荷均衡为次要
- 系统名称更新：万宁睿和排班系统


## V2.0.3.2自动全国城市直线距离
- 新增【城市坐标表】/cities：用于城市→经纬度维护/CSV导入
- 距离计算逻辑：先查 CityDistance（人工/缓存）→ 未命中则用城市经纬度计算直线距离（Haversine）并自动写回 CityDistance 缓存
- 你无需再手工录入全国城市对距离，只需补齐城市坐标（可一次性CSV导入）


## V2.0.3.2内置全国省会/直辖市城市直线距离
- 系统内置主要省会/直辖市（含港澳）城市对直线距离（首次启动自动写入城市距离表）
- 默认不再使用经纬度自动计算（AUTO_DISTANCE_BY_GEO=False），减少维护
- 你无需手工录入全国距离；仅少量非省会城市可按需补充


## V2.0.3.2 修复
- 修复 Windows 下启动时报 SyntaxError（UploadFile import 位置错误）


## V2.0.3 修复
- 修复启动时报 NameError: Session 未导入（main.py 类型注解）
- 已对全部 .py 文件做编译检查，确保无语法错误

- 修复：main.py 中 seed 函数位置与 Session/SEED_CITY_DISTANCES 导入，避免启动 NameError


## V2.0.3 新增功能
1) 全国主要城市直线距离（内置）
- 内置：北京/上海/广州/天津/沈阳 + 各省省会 + 直辖市（含港澳）两两直线距离（km）
- 首次启动自动写入【城市距离表】，用于“就近优先”排班评分

2) 排班导出日历（ICS）
- 页面：/calendar
- 支持导出 all.ics（全部排班）与 按稽查员导出
- .ics 可导入钉钉日历（钉钉→日历→导入日历→选择 .ics）

3) 模板下载/上传导入（XLSX）
- 页面：/imports
- 下载固定字段模板 → Excel 填写 → 上传导入
- 稽查员：同名更新，否则新增
- 任务：按 项目名+开始日期+城市 更新/新增


## V2.0.3 修复
- 修复上传模板时报 NameError: File 未定义（补齐 fastapi File import）


## V2.0.3 修复
- 彻底修复 File 未导入导致的 NameError（确保 main.py 顶部 from fastapi import ... , File）


## V2.0.3 修复
- 修复模板上传接口使用 File(...) 时 main.py 顶部未导入 File 导致 NameError
