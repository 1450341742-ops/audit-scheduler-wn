{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">排班日历视图</h4>

<div class="alert alert-info">
  <b>说明：</b>这里直接以“日程日历”的方式可视化展示排班结果（不需要导出）。<br/>
  <b>用法：</b>可切换 月 / 周 / 日 视图；可按稽查员筛选；点击日程可查看详情。
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label">筛选稽查员</label>
    <select id="auditorFilter" class="form-select">
      <option value="">全部稽查员</option>
      {% for a in auditors %}
      <option value="{{ a.id }}">{{ a.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">年份</label>
    <select id="yearFilter" class="form-select"></select>
  </div>
  <div class="col-md-4">
    <label class="form-label">月份</label>
    <select id="monthFilter" class="form-select"></select>
  </div>

</div>

<div id="calendar"></div>

<style>
.day-mark { font-size: 12px; margin-left: 4px; padding: 0 4px; border-radius: 4px; }
.day-mark-holiday { color: #1a7f37; background: rgba(26,127,55,.08); }
.day-mark-workday { color: #d1242f; background: rgba(209,36,47,.08); }
.day-mark-adjust { color: #9a6700; background: rgba(154,103,0,.10); }
</style>


<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const auditorSelect = document.getElementById('auditorFilter');
  const yearSelect = document.getElementById('yearFilter');
  const monthSelect = document.getElementById('monthFilter');

  // 年/月下拉（默认覆盖当前年±2，可自行改范围）
  const now = new Date();
  const y0 = now.getFullYear();
  const yearMin = y0 - 2;
  const yearMax = y0 + 2;
  for (let y = yearMin; y <= yearMax; y++) {
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    yearSelect.appendChild(opt);
  }
  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement('option');
    opt.value = String(m);
    opt.textContent = String(m) + '月';
    monthSelect.appendChild(opt);
  }
  yearSelect.value = String(y0);
  monthSelect.value = String(now.getMonth() + 1);



  let dayMarks = {}; // { 'YYYY-MM-DD': {type,label} }

  function fetchDayMarks(info) {
    const params = new URLSearchParams();
    params.set("start", info.startStr);
    params.set("end", info.endStr);
    return fetch("/api/calendar/day-marks?" + params.toString())
      .then(r => r.json())
      .then(list => {
        dayMarks = {};
        (list || []).forEach(it => { if (it.date) dayMarks[it.date] = it; });
      })
      .catch(() => { dayMarks = {}; });
  }

  function buildEventsUrl(info) {
    const params = new URLSearchParams();
    params.set("start", info.startStr);
    params.set("end", info.endStr);
    if (auditorSelect.value) params.set("auditor_id", auditorSelect.value);
    return "/api/calendar/events?" + params.toString();
  }

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'zh-cn',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    navLinks: true,
    nowIndicator: true,
    dayMaxEvents: true,
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

    datesSet: function(dateInfo) {
      // 同步年/月下拉为当前视图月份
      const d = dateInfo.view.currentStart;
      if (d) {
        yearSelect.value = String(d.getFullYear());
        monthSelect.value = String(d.getMonth() + 1);
      }

      // 每次切换视图/月份时，加载该区间的休/班/调休标识
      fetchDayMarks({startStr: dateInfo.startStr, endStr: dateInfo.endStr}).then(() => {
        calendar.rerenderDates();
      });
    },
    dayCellDidMount: function(arg) {
      const d = arg.date;
      const key = d.toISOString().slice(0,10);
      const mk = dayMarks[key];
      if (!mk) return;
      const span = document.createElement("span");
      span.classList.add("day-mark");
      if (mk.type === "holiday") span.classList.add("day-mark-holiday");
      else if (mk.type === "workday") span.classList.add("day-mark-workday");
      else span.classList.add("day-mark-adjust");
      span.textContent = (mk.label || (mk.type==="holiday"?"休": mk.type==="workday"?"班":"调"));
      // 放在日期数字旁边
      const top = arg.el.querySelector(".fc-daygrid-day-top");
      if (top) top.appendChild(span);
    },
    events: function(info, successCallback, failureCallback) {
      fetch(buildEventsUrl(info))
        .then(r => r.json())
        .then(data => successCallback(data))
        .catch(err => failureCallback(err));
    },
    eventClick: function(info) {
      const p = info.event.extendedProps || {};
      const lines = [];
      if (p.project) lines.push("项目：" + p.project);
      if (p.city) lines.push("城市：" + p.city);
      if (p.role) lines.push("角色：" + (p.role === "leader" ? "组长" : "成员"));
      if (p.auditor) lines.push("稽查员：" + p.auditor);
      if (p.date_range) lines.push("时间：" + p.date_range);
      if (p.travel) lines.push("出发→到达：" + p.travel);
      if (p.distance_km !== undefined) lines.push("直线距离(km)：" + p.distance_km);
      alert(lines.join("\n") || (info.event.title || ""));
    }
  });

  calendar.render();

  function jumpToYM() {
    const y = parseInt(yearSelect.value || String(new Date().getFullYear()));
    const m = parseInt(monthSelect.value || '1');
    // 跳到当月 1 号
    calendar.gotoDate(new Date(y, m - 1, 1));
  }

  auditorSelect.addEventListener('change', function() {
    calendar.refetchEvents();
  });
  yearSelect.addEventListener('change', jumpToYM);
  monthSelect.addEventListener('change', jumpToYM);
});
</script>
{% endblock %}
